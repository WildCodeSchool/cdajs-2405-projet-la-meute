<?xml version="1.0" encoding="UTF-8"?>
<dataConfig>
    <!-- Configuration de la source de données -->
    <dataSource
        type="JdbcDataSource"
        driver="org.postgresql.Driver"
        url="jdbc:postgresql://${env.DBHOST}:${env.DBPORT}/${env.DBNAME}"
        user="${env.DBUSERNAME}"
        password="${env.DBPASS}" />

    <!-- Configuration des documents à indexer -->
    <document>
        <!-- Données du formateur (trainer) -->
        <entity name="trainer"
            query="
                SELECT id AS trainer_id,
                    lastname,
                    firstname,
                    email,
                    phone_number,
                    city,
                    postal_code,
                    company_name
                FROM trainer;">
            <field column="trainer_id" name="trainer_id" />
            <field column="lastname" name="lastname" />
            <field column="firstname" name="firstname" />
            <field column="email" name="email" />
            <field column="phone_number" name="phone_number" />
            <field column="city" name="city" />
            <field column="postal_code" name="postal_code" />
            <field column="company_name" name="company_name" />
        </entity>

        <!-- Données du propriétaire (owner) -->
        <entity name="owner"
            query="
                SELECT owner.id AS owner_id,
                    owner.lastname,
                    owner.firstname,
                    owner.email,
                    owner.phone_number,
                    owner.city,
                    owner.postal_code,
                    count(dog.id) AS dog_count
                FROM owner
                    LEFT JOIN dog ON dog.owner_id = owner.id
                GROUP BY 
                    owner.id, owner.lastname, owner.firstname, owner.email, owner.phone_number, owner.city, owner.postal_code;">
            <field column="owner_id" name="owner_id" />
            <field column="lastname" name="lastname" />
            <field column="firstname" name="firstname" />
            <field column="email" name="email" />
            <field column="phone_number" name="phone_number" />
            <field column="city" name="city" />
            <field column="postal_code" name="postal_code" />
            <field column="dog_count" name="dog_count" />
        </entity>

        <!-- Données des événements (event) -->
        <entity name="event"
            query="
                SELECT event.id AS event_id,
                    event.date,
                    event.title,
                    event.description,
                    event.location,
                    event.group_max_size,
                    event.trainer_id,
                    trainer.lastname AS trainer_lastname,
                    trainer.firstname AS trainer_firstname,
                    trainer.email AS trainer_email,
                    trainer.phone_number AS trainer_phone_number,
                    trainer.city AS trainer_city,
                    trainer.postal_code AS trainer_postal_code,
                    trainer.company_name AS trainer_company_name
                FROM event
                    INNER JOIN trainer ON trainer.id = event.trainer_id;">
            <field column="event_id" name="event_id" />
            <field column="date" name="date" />
            <field column="title" name="title" />
            <field column="description" name="description" />
            <field column="location" name="location" />
            <field column="group_max_size" name="group_max_size" />
            <field column="trainer_id" name="trainer_id" />
            <field column="trainer_lastname" name="trainer_lastname" />
            <field column="trainer_firstname" name="trainer_firstname" />
            <field column="trainer_email" name="trainer_email" />
            <field column="trainer_phone_number" name="trainer_phone_number" />
            <field column="trainer_city" name="trainer_city" />
            <field column="trainer_postal_code" name="trainer_postal_code" />
            <field column="trainer_company_name" name="trainer_company_name" />
        </entity>
    </document>
</dataConfig>
